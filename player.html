<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-g">
    <title>HLS ABR Test Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        video { width: 80%; max-width: 800px; background-color: black; }
        #qualityLevels { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>My Go HLS ABR Server Test</h1>
    <video id="video" controls></video>
    <div id="qualityLevels"></div>

    <script>
        var video = document.getElementById('video');
        var videoSrc = 'https://a2de-61-108-87-140.ngrok-free.app/master.m3u8'; // ìš°ë¦¬ ì„œë²„ ì£¼ì†Œ

         // --- ì¸¡ì • ë¡œì§ ì¶”ê°€ ì‹œì‘ ---
        let playRequestTime = 0;

        // 'ì¬ìƒ' ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ (ì‚¬ìš©ìê°€ ì¬ìƒ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ ìë™ì¬ìƒ ì‹œì‘)
        // ê·¸ ìˆœê°„ì˜ ì‹œê°„ì„ ê¸°ë¡í•©ë‹ˆë‹¤.
        video.addEventListener('play', () => {
            if (playRequestTime === 0) { // ì²˜ìŒ í•œ ë²ˆë§Œ ê¸°ë¡
                playRequestTime = performance.now();
                console.log('ì¬ìƒ ì‹œì‘ ìš”ì²­ ì‹œê°„ ê¸°ë¡:', playRequestTime);
            }
        });

        // 'ì¬ìƒ ì¤‘' ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ (ë²„í¼ë§ì´ ëë‚˜ê³  ì‹¤ì œ ì˜ìƒ í”„ë ˆì„ì´ ì²˜ìŒ ë‚˜ì˜¬ ë•Œ)
        // ì‹œì‘ ìš”ì²­ ì‹œê°„ê³¼ì˜ ì°¨ì´ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
        video.addEventListener('playing', () => {
            if (playRequestTime > 0) {
                const timeToFirstFrame = performance.now() - playRequestTime;
                console.log(`%cğŸ‰ ì²« í”„ë ˆì„ê¹Œì§€ ê±¸ë¦° ì‹œê°„ (TTFF): ${timeToFirstFrame.toFixed(2)} ms`, 'color: blue; font-size: 1.2em;');
                playRequestTime = -1; // ì¸¡ì •ì´ ëë‚¬ìŒì„ í‘œì‹œ
            }
        });
        // --- ì¸¡ì • ë¡œì§ ì¶”ê°€ ë ---

        if (Hls.isSupported()) {
            // VOD Fast Startë¥¼ ìœ„í•œ hls.js ì„¤ì •
            var config = {
                // ì´ ì„¤ì •ë“¤ì€ í”Œë ˆì´ì–´ê°€ ë²„í¼ë§ë³´ë‹¤ ì¦‰ì‹œ ì¬ìƒì„ ìš°ì„ í•˜ë„ë¡ ìœ ë„í•©ë‹ˆë‹¤.
                maxBufferLength: 30,
                maxMaxBufferLength: 120, // 2ë¶„
            };

            var hls = new Hls(config);
            hls.loadSource(videoSrc);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                console.log('Manifest loaded, found ' + data.levels.length + ' quality levels');

                const qualityLevelsDiv = document.getElementById('qualityLevels');

                // "Auto" ë²„íŠ¼ ìƒì„±
                const autoButton = document.createElement('button');
                autoButton.innerText = 'Auto';
                autoButton.onclick = () => { hls.currentLevel = -1; }; // -1ì€ ìë™ ëª¨ë“œ
                qualityLevelsDiv.appendChild(autoButton);

                // ê° í™”ì§ˆë³„ ì„ íƒ ë²„íŠ¼ ìƒì„±
                data.levels.forEach((level, index) => {
                    const button = document.createElement('button');
                    button.innerText = level.height + 'p'; // 720p, 360p
                    button.onclick = () => { hls.currentLevel = index; };
                    qualityLevelsDiv.appendChild(button);
                });
            });

        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            // Safari ê°™ì€ ë„¤ì´í‹°ë¸Œ ì§€ì› ë¸Œë¼ìš°ì €ìš©
            video.src = videoSrc;
        }
    </script>
</body>
</html>